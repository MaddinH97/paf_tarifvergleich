<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Tarifvergleich Altersvorsorge</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f8; }
        .topbar { background:#111827; color:#fff; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; }
        .brand { font-size:18px; font-weight:700; }
        .actions { display:flex; gap:10px; align-items:center; }
        .actions .btn { background:#2563eb; color:#fff; text-decoration:none; padding:8px 12px; border-radius:6px; font-size:14px; display:inline-block; }

        header.sub { background:#1f2937; color:white; padding:10px 20px; font-size:16px; }

        .tabs { display:flex; background:#e5e7eb; padding:5px; }
        .tab { padding:8px 12px; margin-right:5px; background:#d1d5db; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:6px; }
        .tab.active { background:white; font-weight:bold; }
        .tab button { border:none; background:transparent; cursor:pointer; color:red; font-weight:bold; }
        .add-tab { padding:8px 12px; cursor:pointer; background:#2563eb; color:white; border-radius:4px; font-weight:bold; }

        .content { padding:20px; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
        .box { background:white; padding:15px; border-radius:6px; }
        .box h3 { margin-top:0; }

        .form-group { margin-bottom:10px; }
        label { display:block; font-size:14px; margin-bottom:4px; }

        input, select { width:100%; padding:6px; box-sizing:border-box; }

        .tarif-list label { display:block; margin:6px 0; }

        .hint { font-size:13px; color:#6b7280; margin-top:8px; }

        .chart-container { margin-top:30px; background:white; padding:15px; border-radius:6px; }
        button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
        .btn-secondary { background:#e5e7eb; }
        .btn-primary { background:#2563eb; color:#fff; }
        .row { display:flex; gap:10px; }
        .row > * { flex:1; }
        .error { color:#b91c1c; margin-top:8px; font-size:13px; }
        .success { color:#065f46; margin-top:8px; font-size:13px; }
    </style>
</head>

<body>

<header class="topbar">
    <div class="brand">Tarifvergleich</div>
    <div class="actions">
        <a class="btn" href="/admin.html">Admin</a>
    </div>
</header>

<header class="sub">
    Tarifvergleich ‚Äì Altersvorsorge
</header>

<div class="tabs" id="tabs">
    <div class="tab active" onclick="switchTab(0)">Berechnung 1</div>
    <div class="add-tab" onclick="addTab()">+</div>
</div>

<div class="content" id="content">
    <div class="grid">
        <div class="box">
            <h3>Parameter</h3>

            <div class="form-group">
                <label for="einstiegsalter">Einstiegsalter</label>
                <input id="einstiegsalter" type="number" value="30" min="0" max="100">
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="laufzeitSelect">Laufzeit (Jahre)</label>
                    <select id="laufzeitSelect"></select>
                </div>

                <div class="form-group">
                    <label for="beitragSelect">Beitrag (‚Ç¨ / Monat)</label>
                    <select id="beitragSelect"></select>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label for="kapASelect">Kapitalanlage A</label>
                    <select id="kapASelect"></select>
                </div>
                <div class="form-group">
                    <label for="kapBSelect">Kapitalanlage B</label>
                    <select id="kapBSelect"></select>
                </div>
            </div>

            <div class="form-group">
                <label for="fondswechsel1">Fondswechsel 1 (Jahr)</label>
                <input id="fondswechsel1" type="number" placeholder="z.B. 10">
            </div>

            <div class="form-group">
                <label for="fondswechsel2">Fondswechsel 2 (Jahr)</label>
                <input id="fondswechsel2" type="number" placeholder="z.B. 20">
            </div>

            <div class="form-group">
                <label for="steuersatzRente">Steuersatz Rente (%)</label>
                <input id="steuersatzRente" type="number" placeholder="z.B. 20">
            </div>

            <div class="hint">Tarife werden rechts automatisch anhand Beitrag+Laufzeit gefiltert.</div>

            <div style="margin-top:12px;">
                <button class="btn-primary" onclick="berechnen()">Berechnen</button>
                <div id="status" class="hint"></div>
                <div id="error" class="error"></div>
            </div>
        </div>

        <div class="box">
            <h3>Tarife ausw√§hlen</h3>

            <button class="btn-secondary" onclick="selectAllTarife()">Alle ausw√§hlen</button>

            <div class="tarif-list" id="tarifList">
                <div class="hint">Lade Tarife‚Ä¶</div>
            </div>

            <div class="hint" id="eligibleHint"></div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
</div>

<script>
    let chart;

    const BEITRAG_WERTE = [25, 50, 75, 100, 125, 150, 175, 200];
    const LAUFZEIT_WERTE = [15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65];

    function initChart() {
        const ctx = document.getElementById('chart');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    x: { title: { display: true, text: 'Jahre' } },
                    y: { title: { display: true, text: 'Wert (‚Ç¨)' } }
                }
            }
        });
    }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg || '';
    }
    function setError(msg) {
        document.getElementById('error').textContent = msg || '';
    }

    function selectAllTarife() {
        document.querySelectorAll('#tarifList input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    function getSelectedBeitrag() {
        return parseInt(document.getElementById('beitragSelect').value, 10);
    }
    function getSelectedLaufzeit() {
        return parseInt(document.getElementById('laufzeitSelect').value, 10);
    }
    function getEinstiegsalter() {
        return parseInt(document.getElementById('einstiegsalter').value, 10);
    }
    function getKapAId() {
        return parseInt(document.getElementById('kapASelect').value, 10);
    }
    function getKapBId() {
        return parseInt(document.getElementById('kapBSelect').value, 10);
    }

    function getSelectedTarifIds() {
        return Array.from(document.querySelectorAll('#tarifList input[type="checkbox"]:checked'))
            .map(cb => parseInt(cb.value, 10));
    }

    function initDropdowns() {
        const beitragSelect = document.getElementById('beitragSelect');
        beitragSelect.innerHTML = '';
        BEITRAG_WERTE.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = `${v} ‚Ç¨ / Monat`;
            beitragSelect.appendChild(opt);
        });
        beitragSelect.value = "50";

        const laufzeitSelect = document.getElementById('laufzeitSelect');
        laufzeitSelect.innerHTML = '';
        LAUFZEIT_WERTE.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = `${v} Jahre`;
            laufzeitSelect.appendChild(opt);
        });
        laufzeitSelect.value = "30";

        beitragSelect.addEventListener('change', loadTarifeVerfuegbar);
        laufzeitSelect.addEventListener('change', loadTarifeVerfuegbar);
    }

    async function loadKapitalanlagen() {
        const res = await fetch('/api/kapitalanlagen');
        const anlagen = await res.json();

        const a = document.getElementById('kapASelect');
        const b = document.getElementById('kapBSelect');
        a.innerHTML = '';
        b.innerHTML = '';

        anlagen.forEach(k => {
            const optA = document.createElement('option');
            optA.value = k.id;
            optA.textContent = k.name;
            a.appendChild(optA);

            const optB = document.createElement('option');
            optB.value = k.id;
            optB.textContent = k.name;
            b.appendChild(optB);
        });

        // Default: 9% falls vorhanden, sonst erste Option
        const nine = anlagen.find(x => (x.name || '').includes("9%"));
        if (nine) {
            a.value = String(nine.id);
            b.value = String(nine.id);
        } else if (anlagen.length) {
            a.value = String(anlagen[0].id);
            b.value = String(anlagen[0].id);
        }
    }

    async function loadTarifeVerfuegbar() {
        setError('');
        const beitrag = getSelectedBeitrag();
        const laufzeit = getSelectedLaufzeit();

        const res = await fetch(`/api/tarife/verfuegbar?beitrag=${beitrag}&laufzeit=${laufzeit}`);
        const tarife = await res.json();

        const list = document.getElementById('tarifList');
        list.innerHTML = '';

        if (!tarife.length) {
            list.innerHTML = `<div style="color:#6b7280">F√ºr diese Kombination sind keine Tarife aktiv verf√ºgbar.</div>`;
            return;
        }

        tarife.forEach(t => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${t.id}"> ${t.tarifName} (${t.tarifCode})`;
            list.appendChild(label);
        });
    }

    async function berechnen() {
        setError('');
        setStatus('Berechne‚Ä¶');

        const beitragMonat = getSelectedBeitrag();
        const laufzeitJahre = getSelectedLaufzeit();
        const einstiegsalter = getEinstiegsalter();
        const kapitalanlageAId = getKapAId();
        const kapitalanlageBId = getKapBId();
        const tarifIds = getSelectedTarifIds();

        if (!tarifIds.length) {
            setStatus('');
            setError('Bitte mindestens einen Tarif ausw√§hlen.');
            return;
        }

        const payload = {
            beitragMonat,
            laufzeitJahre,
            einstiegsalter,
            kapitalanlageAId,
            kapitalanlageBId,
            tarifIds
        };

        try {
            const res = await fetch('/api/berechnung', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(`HTTP ${res.status}: ${txt}`);
            }

            const ergebnisse = await res.json();
            setStatus(`OK: ${ergebnisse.length} Ergebnis(se).`);

            renderChart(ergebnisse, laufzeitJahre);
        } catch (e) {
            setStatus('');
            setError('Fehler bei Berechnung: ' + e.message);
        }
    }

    function renderChart(ergebnisse, laufzeitJahre) {
        // Labels: 0..laufzeit
        const labels = [];
        for (let y = 0; y <= laufzeitJahre; y++) labels.push(String(y));

        // Datasets pro Tarif
        const datasets = ergebnisse.map((r, idx) => {
            const map = new Map();
            (r.wertentwicklung || []).forEach(p => map.set(String(p.jahr), p.wert));

            const data = labels.map(l => map.has(l) ? map.get(l) : null);

            return {
                label: `${r.tarifName} (${r.tarifCode})`,
                data,
                fill: false,
                tension: 0.15
            };
        });

        chart.data.labels = labels;
        chart.data.datasets = datasets;
        chart.update();
    }

    function addTab() { alert("Weitere Reiter kommen sp√§ter üôÇ"); }
    function switchTab(index) { /* Dummy */ }

    // Initial
    initChart();
    initDropdowns();
    loadKapitalanlagen();
    loadTarifeVerfuegbar();
</script>

</body>
</html>