<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tarifvergleich</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #fafafa; color: #111; }

        header {
            padding: 16px 18px;
            border-bottom: 1px solid #e6e6e6;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        header .row { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
        header h1 { margin: 0; font-size: 18px; }
        header a { text-decoration: none; color: #1a73e8; font-weight: 600; }

        main { padding: 18px; max-width: 1400px; margin: 0 auto; }

        .card { background: #fff; border: 1px solid #e6e6e6; border-radius: 12px; padding: 14px; margin-bottom: 14px; }

        .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
        .col-3 { grid-column: span 3; }
        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-12 { grid-column: span 12; }

        @media (max-width: 980px) { .col-3,.col-4,.col-6 { grid-column: span 12; } }

        label { display: block; font-size: 12px; opacity: .75; margin-bottom: 6px; }

        input, select {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 10px;
            background: #fff;
            outline: none;
        }

        input:focus, select:focus { border-color: #7aa7ff; box-shadow: 0 0 0 3px rgba(70,130,255,0.15); }

        .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        button {
            padding: 10px 12px;
            border: 1px solid #cfcfcf;
            background: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        button.primary { background: #1a73e8; border-color: #1a73e8; color: #fff; }
        button:hover { filter: brightness(0.98); }

        .muted { opacity: .75; font-size: 12px; }

        .tarife {
            max-height: 220px;
            overflow: auto;
            border: 1px solid #e2e2e2;
            border-radius: 10px;
            padding: 8px;
            background: #fcfcfc;
        }
        .tarif-item { display: flex; gap: 10px; align-items: center; padding: 6px 6px; border-radius: 8px; }
        .tarif-item:hover { background: #f2f6ff; }
        .tarif-item input { width: auto; }

        .chart-wrap { height: 360px; }

        /* ===== Tabelle sticky + scroll ===== */
        #resultsTableWrapper {
            margin-top: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: #fff;
        }
        #resultsTableWrapper .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 520px;
        }
        #resultsTableWrapper table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        #resultsTableWrapper thead th {
            position: sticky;
            top: 0;
            z-index: 3;
            background: #f7f7f7;
            border-bottom: 1px solid #ccc;
            padding: 10px 8px;
            white-space: nowrap;
        }
        #resultsTableWrapper thead tr:first-child th {
            background: #f0f0f0;
            z-index: 4;
            font-weight: 700;
        }
        #resultsTableWrapper td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }
        #resultsTableWrapper tbody tr:nth-child(even) td { background: #fcfcfc; }

        /* Sticky left columns */
        #resultsTableWrapper .sticky-col-1,
        #resultsTableWrapper .sticky-col-2 {
            position: sticky;
            left: 0;
            z-index: 2;
            background: #fff;
        }
        #resultsTableWrapper .sticky-col-2 { left: 80px; } /* wird per JS gesetzt */
        #resultsTableWrapper thead .sticky-col-1,
        #resultsTableWrapper thead .sticky-col-2 {
            z-index: 6;
            background: #f0f0f0;
        }
        #resultsTableWrapper .sticky-shadow { box-shadow: 2px 0 0 rgba(0,0,0,0.06); }

        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        #resultsTableWrapper tbody tr:hover td { background: #f3f8ff; }

        #resultsTableWrapper td.col-hover,
        #resultsTableWrapper th.col-hover {
            outline: 2px solid rgba(30, 120, 255, 0.35);
            outline-offset: -2px;
        }

        #resultsControls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        #resultsControls button {
            padding: 8px 10px;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
        }
        #resultsControls button:hover { background: #f6f6f6; }

        .error {
            color: #b00020;
            background: #fff0f2;
            border: 1px solid #ffd2d8;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
<header>
    <div class="row">
        <h1>Tarifvergleich</h1>
        <a href="admin.html">Admin</a>
    </div>
</header>

<main>

    <div class="card">
        <div class="grid">
            <div class="col-3">
                <label>Beitrag / Monat (EUR)</label>
                <select id="beitragMonat"></select>
            </div>

            <div class="col-3">
                <label>Laufzeit (Jahre)</label>
                <select id="laufzeitJahre"></select>
            </div>

            <div class="col-3">
                <label for="alter">Einstiegsalter</label>
                <input id="alter" type="number" value="30" min="0" step="1">
            </div>

            <div class="col-3">
                <label for="garantieModus">Garantiezins (Modus)</label>
                <select id="garantieModus">
                    <option value="OHNE_UEBERSCHUESSE">Ohne Überschüsse</option>
                    <option value="MIT_UEBERSCHUESSEN">Mit Überschüsse</option>
                </select>
            </div>

            <div class="col-6">
                <label for="kapA">Kapitalanlage A</label>
                <select id="kapA"></select>
            </div>

            <div class="col-6">
                <label for="kapB">Kapitalanlage B (nur für Hybrid relevant)</label>
                <select id="kapB"></select>
            </div>

            <div class="col-12">
                <label>Tarife auswählen</label>
                <div class="tarife" id="tarifList">
                    <div class="muted">Lade Tarife…</div>
                </div>
            </div>

            <div class="col-12">
                <div class="actions">
                    <button class="primary" id="btnCalc">Berechnen</button>
                    <button type="button" id="btnSelectAll">Alle auswählen</button>
                    <button type="button" id="btnSelectNone">Auswahl löschen</button>
                    <span class="muted" id="status"></span>
                </div>
                <div id="errBox" class="error" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="chart-wrap">
            <canvas id="chart"></canvas>
        </div>

        <div id="resultsSection" style="margin-top:24px;">
            <div id="resultsControls">
                <button type="button" id="btnExpandAll">Alle Tarife ausklappen</button>
                <button type="button" id="btnCollapseAll">Alle Tarife einklappen</button>
                <button type="button" id="btnExportCsv">CSV exportieren</button>
                <span id="resultsHint" class="muted"></span>
            </div>

            <div id="resultsTableWrapper" style="margin-top:12px;"></div>
        </div>
    </div>

</main>

<script>
    async function apiGet(url) {
        const r = await fetch(url, { headers: { "Accept": "application/json" }});
        if (!r.ok) throw new Error(`Error: ${url} -> ${r.status}`);
        return r.json();
    }

    async function apiPost(url, body) {
        const r = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify(body)
        });
        if (!r.ok) {
            const text = await r.text();
            throw new Error(`Error: ${url} -> ${r.status}\n${text}`);
        }
        return r.json();
    }

    function showError(msg) {
        const box = document.getElementById("errBox");
        box.style.display = "block";
        box.textContent = msg;
    }
    function clearError() {
        const box = document.getElementById("errBox");
        box.style.display = "none";
        box.textContent = "";
    }

    function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => ({
            "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
    }

    function fillSelectSteps(selectEl, min, max, step, defaultValue) {
        selectEl.innerHTML = "";
        for (let v = min; v <= max; v += step) {
            const opt = document.createElement("option");
            opt.value = String(v);
            opt.textContent = String(v);
            if (defaultValue != null && v === defaultValue) opt.selected = true;
            selectEl.appendChild(opt);
        }
    }

    // State
    let kapitalanlagen = [];
    let tarife = [];
    let chartInstance = null;

    const tableState = {
        collapsedTarifIds: new Set(),
        lastResults: null
    };

    window.addEventListener("DOMContentLoaded", async () => {
        try {
            // Dropdowns in 5er Schritten (wie besprochen)
            fillSelectSteps(document.getElementById("beitragMonat"), 5, 200, 5, 50);
            fillSelectSteps(document.getElementById("laufzeitJahre"), 20, 45, 5, 30);

            await loadKapitalanlagen();
            await loadTarife();
            wireButtons();
            document.getElementById("status").textContent = "Bereit.";
        } catch (e) {
            showError(String(e));
        }
    });

    async function loadKapitalanlagen() {
        kapitalanlagen = await apiGet("/api/kapitalanlagen");

        const selA = document.getElementById("kapA");
        const selB = document.getElementById("kapB");
        selA.innerHTML = "";
        selB.innerHTML = "";

        // Optional: "leer" erlauben
        const emptyA = document.createElement("option");
        emptyA.value = "";
        emptyA.textContent = "— auswählen —";
        selA.appendChild(emptyA);

        const emptyB = document.createElement("option");
        emptyB.value = "";
        emptyB.textContent = "— auswählen —";
        selB.appendChild(emptyB);

        for (const k of kapitalanlagen) {
            const optA = document.createElement("option");
            optA.value = k.id;
            optA.textContent = k.name;
            selA.appendChild(optA);

            const optB = document.createElement("option");
            optB.value = k.id;
            optB.textContent = k.name;
            selB.appendChild(optB);
        }

        // Defaults
        const fantasy = kapitalanlagen.find(x => (x.name || "").toLowerCase().includes("fantasy"));
        if (fantasy) selA.value = String(fantasy.id);

        const rend3 = kapitalanlagen.find(x => (x.name || "").includes("3%"));
        if (rend3) selB.value = String(rend3.id);
    }

    async function loadTarife() {
        const beitrag = Number(document.getElementById("beitragMonat").value);
        const laufzeit = Number(document.getElementById("laufzeitJahre").value);

        tarife = await apiGet(`/api/tarife?beitragMonat=${beitrag}&laufzeit=${laufzeit}`);

        const list = document.getElementById("tarifList");
        list.innerHTML = "";

        for (const t of tarife) {
            const row = document.createElement("label");
            row.className = "tarif-item";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = t.id;

            if (!t.verfuegbar) {
                cb.disabled = true;
                cb.checked = false;
            } else {
                cb.checked = true; // oder vorherige Auswahl merken (optional)
            }

            const suffix = t.verfuegbar ? "" : ` <span class="muted">– keine Daten vorhanden</span>`;

            const text = document.createElement("div");
            text.innerHTML = `
      <div><b>${escapeHtml(t.tarifName)}</b> <span class="muted">(${escapeHtml(t.tarifCode||"")})</span>${suffix}</div>
      <div class="muted">${escapeHtml(t.anbieterName||"")}</div>
    `;

            row.appendChild(cb);
            row.appendChild(text);
            list.appendChild(row);
        }
    }

    function wireButtons() {
        document.getElementById("btnCalc").addEventListener("click", onCalculate);

        document.getElementById("btnSelectAll").onclick = () => {
            document.querySelectorAll("#tarifList input[type=checkbox]").forEach(cb => cb.checked = true);
        };
        document.getElementById("btnSelectNone").onclick = () => {
            document.querySelectorAll("#tarifList input[type=checkbox]").forEach(cb => cb.checked = false);
        };

        // Wenn Beitrag/Laufzeit geändert wird: Tarife neu laden
        document.getElementById("beitragMonat").addEventListener("change", loadTarifeSafe);
        document.getElementById("laufzeitJahre").addEventListener("change", loadTarifeSafe);

        document.getElementById("btnExpandAll").onclick = () => {
            tableState.collapsedTarifIds.clear();
            renderResultsTable(tableState.lastResults);
        };
        document.getElementById("btnCollapseAll").onclick = () => {
            tableState.collapsedTarifIds.clear();
            for (const r of (tableState.lastResults || [])) tableState.collapsedTarifIds.add(r.tarifId);
            renderResultsTable(tableState.lastResults);
        };
        document.getElementById("btnExportCsv").onclick = () => {
            const csv = buildCsvFromCurrentState(tableState.lastResults);
            downloadTextFile(csv, "tarifvergleich_ergebnisse.csv", "text/csv;charset=utf-8;");
        };
    }

    async function loadTarifeSafe() {
        try {
            clearError();
            await loadTarife();
        } catch (e) {
            showError(String(e));
        }
    }

    async function onCalculate() {
        clearError();
        document.getElementById("status").textContent = "Berechne…";

        try {
            // WICHTIG: richtige IDs
            const beitragMonat = Number(document.getElementById("beitragMonat").value);
            const laufzeitJahre = Number(document.getElementById("laufzeitJahre").value);
            const einstiegsalter = Number(document.getElementById("alter").value);

            const kapAVal = document.getElementById("kapA").value;
            const kapBVal = document.getElementById("kapB").value;
            const kapitalanlageAId = kapAVal ? Number(kapAVal) : null;
            const kapitalanlageBId = kapBVal ? Number(kapBVal) : null;

            const garantieModus = document.getElementById("garantieModus").value;

            const tarifIds = Array.from(document.querySelectorAll("#tarifList input[type=checkbox]"))
                .filter(cb => cb.checked)
                .map(cb => Number(cb.value));

            if (tarifIds.length === 0) throw new Error("Bitte mindestens einen Tarif auswählen.");

            const req = {
                beitragMonat,
                laufzeitJahre,
                einstiegsalter,
                kapitalanlageAId,
                kapitalanlageBId,
                garantieModus,
                tarifIds
            };

            const results = await apiPost("/api/berechnung", req);

            renderChart(results);
            tableState.lastResults = results;
            renderResultsTable(results);

            document.getElementById("status").textContent = `Fertig. ${results.length} Tarif(e).`;
        } catch (e) {
            showError(String(e));
            document.getElementById("status").textContent = "Fehler.";
        }
    }

    // ===== Chart =====
    function toNumber(v) {
        if (v === null || v === undefined) return 0;
        if (typeof v === "number") return v;
        if (typeof v === "string") return Number(v.replace(",", "."));
        return Number(v);
    }

    function formatEUR(v) {
        const n = toNumber(v);
        return n.toLocaleString("de-DE", { style: "currency", currency: "EUR" });
    }

    function renderChart(results) {
        const ctx = document.getElementById("chart");

        const labels = (results[0]?.wertentwicklung || []).map(w => `J${w.jahr}`);
        const datasets = results.map((r) => ({
            label: `${r.tarifName} (${r.tarifCode})`,
            data: (r.wertentwicklung || []).map(w => toNumber(w.endkapital)),
            tension: 0.15,
            pointRadius: 0,
            borderWidth: 2
        }));

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: "line",
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: {
                    legend: { position: "bottom" },
                    tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${formatEUR(item.raw)}` } }
                }
            }
        });
    }

    // ===== Tabelle =====
    function tdMoney(val) {
        const td = document.createElement("td");
        td.textContent = (val === null || val === undefined) ? "-" : formatEUR(val);
        td.className = "text-right";
        return td;
    }

    function renderResultsTable(results) {
        const wrapper = document.getElementById("resultsTableWrapper");
        const hint = document.getElementById("resultsHint");
        wrapper.innerHTML = "";

        if (!results || results.length === 0) {
            wrapper.textContent = "Keine Ergebnisse.";
            hint.textContent = "";
            return;
        }

        const collapsedCount = results.filter(r => tableState.collapsedTarifIds.has(r.tarifId)).length;
        hint.textContent = collapsedCount > 0
            ? `${collapsedCount} Tarif(e) eingeklappt (zeigen nur Endkapital).`
            : `Alle Tarife ausgeklappt.`;

        const scroll = document.createElement("div");
        scroll.className = "table-scroll";
        wrapper.appendChild(scroll);

        const years = results[0].wertentwicklung.map(w => w.jahr);

        const mapByTarif = new Map();
        for (const r of results) {
            const m = new Map();
            for (const w of r.wertentwicklung) m.set(w.jahr, w);
            mapByTarif.set(r.tarifId, m);
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");

        const tr1 = document.createElement("tr");

        const thJahr = document.createElement("th");
        thJahr.textContent = "Jahr";
        thJahr.rowSpan = 2;
        thJahr.className = "sticky-col-1 text-left sticky-shadow";
        tr1.appendChild(thJahr);

        const thSum = document.createElement("th");
        thSum.textContent = "Summe Einzahlungen";
        thSum.rowSpan = 2;
        thSum.className = "sticky-col-2 text-right sticky-shadow";
        tr1.appendChild(thSum);

        for (const r of results) {
            const collapsed = tableState.collapsedTarifIds.has(r.tarifId);

            const thTarif = document.createElement("th");
            thTarif.colSpan = collapsed ? 1 : 4;
            thTarif.className = "text-center";

            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = collapsed ? "▶" : "▼";
            btn.title = collapsed ? "Tarif ausklappen" : "Tarif einklappen";
            btn.style.marginRight = "8px";
            btn.style.padding = "4px 8px";
            btn.style.borderRadius = "8px";
            btn.style.border = "1px solid #ccc";
            btn.style.background = "#fff";
            btn.style.cursor = "pointer";
            btn.onclick = () => {
                if (tableState.collapsedTarifIds.has(r.tarifId)) tableState.collapsedTarifIds.delete(r.tarifId);
                else tableState.collapsedTarifIds.add(r.tarifId);
                renderResultsTable(tableState.lastResults);
            };

            const label = document.createElement("span");
            label.textContent = `${r.tarifName} (${r.tarifCode})`;

            thTarif.appendChild(btn);
            thTarif.appendChild(label);
            tr1.appendChild(thTarif);
        }

        const tr2 = document.createElement("tr");
        for (const r of results) {
            const collapsed = tableState.collapsedTarifIds.has(r.tarifId);
            if (collapsed) {
                const th = document.createElement("th");
                th.textContent = "Kapital (Jahresende)";
                th.className = "text-right";
                tr2.appendChild(th);
            } else {
                const sub = [
                    "Kapital (Jahresende)",
                    "Topf 1 (Fonds)",
                    "Topf 2 (Wertsicherung)",
                    "Topf 3 (Deckungsstock)"
                ];
                for (const s of sub) {
                    const th = document.createElement("th");
                    th.textContent = s;
                    th.className = "text-right";
                    tr2.appendChild(th);
                }
            }
        }

        thead.appendChild(tr1);
        thead.appendChild(tr2);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        for (const year of years) {
            const tr = document.createElement("tr");

            const tdY = document.createElement("td");
            tdY.textContent = String(year);
            tdY.className = "sticky-col-1 text-left sticky-shadow";
            tr.appendChild(tdY);

            const w0 = mapByTarif.get(results[0].tarifId).get(year);
            const tdSum = document.createElement("td");
            tdSum.textContent = formatEUR(w0?.summeEinzahlungen);
            tdSum.className = "sticky-col-2 text-right sticky-shadow";
            tr.appendChild(tdSum);

            for (const r of results) {
                const w = mapByTarif.get(r.tarifId).get(year);
                const collapsed = tableState.collapsedTarifIds.has(r.tarifId);

                tr.appendChild(tdMoney(w?.endkapital));
                if (!collapsed) {
                    tr.appendChild(tdMoney(w?.topf1Fonds));
                    tr.appendChild(tdMoney(w?.topf2Wertsicherungsfonds));
                    tr.appendChild(tdMoney(w?.topf3Deckungsstock));
                }
            }

            tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        scroll.appendChild(table);

        // Sticky Left Offset korrekt setzen
        requestAnimationFrame(() => {
            const firstHeader = thead.querySelector(".sticky-col-1");
            if (!firstHeader) return;
            const w1 = firstHeader.getBoundingClientRect().width;
            wrapper.querySelectorAll(".sticky-col-2").forEach(el => el.style.left = `${w1}px`);
            wrapper.querySelectorAll(".sticky-col-1").forEach(el => el.style.minWidth = "70px");
        });

        attachColumnHover(table);
    }

    function attachColumnHover(table) {
        table.onmousemove = (e) => {
            const cell = e.target.closest("td,th");
            if (!cell) return;
            const row = cell.parentElement;
            if (!row) return;
            const colIndex = [...row.children].indexOf(cell);
            if (colIndex < 0) return;

            clearColHover(table);
            for (const r of table.rows) {
                if (r.children[colIndex]) r.children[colIndex].classList.add("col-hover");
            }
        };
        table.onmouseleave = () => clearColHover(table);
    }

    function clearColHover(table) {
        table.querySelectorAll(".col-hover").forEach(el => el.classList.remove("col-hover"));
    }

    function buildCsvFromCurrentState(results) {
        if (!results || results.length === 0) return "";
        const years = results[0].wertentwicklung.map(w => w.jahr);

        const header = ["Jahr", "Summe Einzahlungen"];
        for (const r of results) {
            const collapsed = tableState.collapsedTarifIds.has(r.tarifId);
            if (collapsed) {
                header.push(`${r.tarifName} (${r.tarifCode}) - Endkapital`);
            } else {
                header.push(`${r.tarifName} (${r.tarifCode}) - Endkapital`);
                header.push(`${r.tarifName} (${r.tarifCode}) - Topf1 Fonds`);
                header.push(`${r.tarifName} (${r.tarifCode}) - Topf2 Wertsicherung`);
                header.push(`${r.tarifName} (${r.tarifCode}) - Topf3 Deckungsstock`);
            }
        }

        const lines = [];
        lines.push(header.map(csvEscape).join(";"));

        const byTarif = new Map();
        for (const r of results) {
            const m = new Map();
            for (const w of r.wertentwicklung) m.set(w.jahr, w);
            byTarif.set(r.tarifId, m);
        }

        for (const year of years) {
            const row = [];
            row.push(String(year));

            const w0 = byTarif.get(results[0].tarifId).get(year);
            row.push(csvNum(w0?.summeEinzahlungen));

            for (const r of results) {
                const w = byTarif.get(r.tarifId).get(year);
                const collapsed = tableState.collapsedTarifIds.has(r.tarifId);

                row.push(csvNum(w?.endkapital));
                if (!collapsed) {
                    row.push(csvNum(w?.topf1Fonds));
                    row.push(csvNum(w?.topf2Wertsicherungsfonds));
                    row.push(csvNum(w?.topf3Deckungsstock));
                }
            }
            lines.push(row.map(csvEscape).join(";"));
        }

        return lines.join("\n");
    }

    function csvNum(v) {
        if (v === null || v === undefined) return "";
        const n = toNumber(v);
        if (Number.isNaN(n)) return "";
        return String(n);
    }

    function csvEscape(v) {
        const s = String(v ?? "");
        if (s.includes(";") || s.includes('"') || s.includes("\n")) return `"${s.replace(/"/g, '""')}"`;
        return s;
    }

    function downloadTextFile(content, filename, mime) {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>